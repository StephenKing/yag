{namespace yag=Tx_Yag_ViewHelpers}
{namespace extlist=Tx_PtExtlist_ViewHelpers}

<extlist:comment>
<!--  
Template for rendering the category manager

Here is a list of objects / variables that can be accessed in this template:


@package YAG
@author Michael Knoll <mimi@kaktusteam.de>
@author Daniel Lienert <daniel@lienert.cc>
-->
</extlist:comment>

<f:layout name="Default" />
<f:section name="main">
	<script type="text/javascript">
	
	//Ext.BLANK_IMAGE_URL = '<?php echo $html->url('/js/ext-2.0.1/resources/images/default/s.gif') ?>';
	
	Ext.onReady(function(){
		
	        
	    var baseRequest = {extensionName:'yag',pluginName:'pi1',controllerName:'Category'};

	    Ext.getUrlParam = function(param) {
    	   var params = Ext.urlDecode(location.search.substring(1));
    	   return param ? params[param] : params;
    	};
	    
		function buildRequest(action, arguments) {
			var actionRequest = baseRequest;
			actionRequest.actionName = action;

			if(arguments) {
				actionRequest.arguments = arguments;
			}

			return actionRequest;
		}
	    
	    var Tree = Ext.tree;

		// Define the tree Category Loader
		var Tree_Category_Loader = new Tree.TreeLoader({
	        dataUrl:"ajax.php",
	        baseParams: {
	        	id: Ext.getUrlParam('id'),
	        	ajaxID: 'yagAjaxDispatcher',
				request: Ext.encode(buildRequest('getSubTree')),
	        }
	    });


		// Create / Edit Form definition
		 var createEditForm = new Ext.form.FormPanel({
	        baseCls: 'x-plain',
	        labelWidth: 55,
	        layout: {
	            type: 'vbox',
	            align: 'stretch'  // Child items are stretched to full width
	        },
	        defaults: {
	            xtype: 'textfield'
	        },

	        items: [{
	        	xtype: 'label',
	        	text: 'Name:'
	        },{
	        	xtype: 'textfield',
	            name: 'name'
	        },{
	        	xtype: 'label',
	        	text: 'Description:'
	        },{
	            xtype: 'textarea',
	            name: 'description',
	            flex: 1  // Take up all *remaining* vertical space
	        }]
	    });

		
		var createNewWindow;
		var editWindow;
	    var button = Ext.get('show-btn');
	    
		var yagCategoryTree = new Tree.TreePanel({
		    el:'categoryTreeDiv',
		    autoScroll:true,
		    animate:true,
		    enableDD:true,
		    containerScroll: true,
		    rootVisible: true,
		    loader: Tree_Category_Loader,
		    tbar : [{
			    	xtype : 'button' , text : 'Delete', 
					handler : function(){ 
				    	var selectedItem = yagCategoryTree.getSelectionModel().getSelectedNode();
						
						if(selectedItem){
							
							Ext.Ajax.request({
						        url:'ajax.php',
						        params: {
									id: Ext.getUrlParam('id'),
									ajaxID: 'yagAjaxDispatcher',
						        	request: Ext.encode(
								        	buildRequest('removeCategory',{
								        		nodeId: selectedItem.id,
									        }))
								},
						        success:function(response, request) {
									selectedItem.remove();
						        },
						        failure:function() {
						            alert("Error while deleting the Category.");
						        }
						    });
						}
			    	}
		    	},{
			    	xtype : 'button' , text : 'Edit', 
					handler : function(){ 
				    	var selectedItem = yagCategoryTree.getSelectionModel().getSelectedNode();
						
						if(selectedItem){
							createEditForm.getForm().findField('name').setValue(selectedItem.text);
				        	createEditForm.getForm().findField('description').setValue(selectedItem.attributes.description);

				        	handleSave = function(text, description){
								if(text){

									Ext.Ajax.request({
								        url:'ajax.php',
								        params: {
											id: Ext.getUrlParam('id'),
											ajaxID: 'yagAjaxDispatcher',
								        	request: Ext.encode(
										        	buildRequest('saveCategory',{
										        		category: selectedItem.id,
											        	categoryTitle: text,
											        	categoryDescription: description
											        }))
										},
								        success:function(response, request) {
									        selectedItem.setText(text);
									        selectedItem.description = description;
								        },
								        failure:function() {
								            alert("Error while saving the category.");
								        }
								    
								    });
								}
							}
							
				        	editWindow = new Ext.Window({
				                title: 'Edit Category',
				                width: 300, height: 200, layout: 'fit', plain: true, bodyStyle: 'padding:5px;', buttonAlign: 'center',
				                items: createEditForm,
				                buttons: [{
				                    text: 'Save',
				                    handler: function(){
				                    	handleSave(createEditForm.getForm().findField('name').getValue(), createEditForm.getForm().findField('description').getValue());
				                    	editWindow.hide();
		                    		}
				                },{
				                    text: 'Cancel',
				                    handler: function(){
				                		editWindow.hide();
			                    	}
				                }]
				            });
				            
				        	createEditForm.getForm().findField('name').setValue('');
				        	createEditForm.getForm().findField('description').setValue('');
				        	editWindow.show(this);
				        	
						} else {
							alert('No category selected!');
						}
			    	}
		    	}, {
				    xtype : 'button' , text : 'Add', 
					handler : function(){ 
						var selectedItem = yagCategoryTree.getSelectionModel().getSelectedNode();
			
						if(!selectedItem){
							selectedItem = yagCategoryTree.getRootNode();
						}
			
						handleCreate = function(text, description){
							if(text){

								var newNode = new Ext.tree.TreeNode ({
									id : 'new',
									text : text,
									description: description
								});
								
								if(selectedItem.isLeaf()) {
									selectedItem.parentNode.insertBefore(newNode, selectedItem.nextSibling);
								} else {
									selectedItem.insertBefore(newNode, selectedItem.firstChild);
									selectedItem.expand();
								}

								Ext.Ajax.request({
							        url:'ajax.php',
							        params: {
										id: Ext.getUrlParam('id'),
										ajaxID: 'yagAjaxDispatcher',
							        	request: Ext.encode(
									        	buildRequest('addCategory',{
									        		parentNodeId: selectedItem.id,
										        	nodeTitle: text,
										        	nodeDescription: description
										        }))
									},
							        success:function(response, request) {
								        alert(response.responseText);
							        },
							        failure:function() {
							            alert("Error while saving the new node.");
							            newNode.delete();
							        }
							    
							    });
							}
						}
							
						
						if(!createNewWindow){
				            createNewWindow = new Ext.Window({
				                title: 'Add new Category',
				                width: 300, height: 200, layout: 'fit', plain: true, bodyStyle: 'padding:5px;', buttonAlign: 'center',
				                items: createEditForm,
				                buttons: [{
				                    text: 'Save',
				                    handler: function(){
				                    	handleCreate(createEditForm.getForm().findField('name').getValue(), createEditForm.getForm().findField('description').getValue());
				                    	createNewWindow.hide();
		                    		}
				                },{
				                    text: 'Cancel',
				                    handler: function(){
				                		createNewWindow.hide();
			                    	}
				                }]
				            });
				        };
				        
				        createEditForm.getForm().findField('name').setValue('');
			        	createEditForm.getForm().findField('description').setValue('');
						createNewWindow.show(this);		
				}
			}],
		});
	    
	    var root = new Tree.AsyncTreeNode({
	        text:'Categories',
	        draggable:false,
	        id:1
	    });
	    yagCategoryTree.setRootNode(root);
	    
	    yagCategoryTree.render();
	    root.expand();
	
	});
	
	</script>
	
	<div id="categoryTreeDiv" style="height:200px; width:200px;"></div>

	<div id="categoryEditDiv" class="x-hidden">
		<div class="x-window-header">Category</div>
			<div id="hello-tabs"><!-- Auto create tab 1 -->
			<div class="x-tab" title="Category edit">
				<p><f:form.textField name="name" /> <f:form.textArea name="description" rows="3" cols="10" /></p>
			</div>
		</div>
	</div>
</f:section>

<f:section name="beButtonsLeft">
</f:section>